
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      --><title>Bat2MatGUI</title><meta name="generator" content="MATLAB 7.10"><meta name="date" content="2010-11-24"><meta name="m-file" content="Bat2MatGUI"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><pre class="codeinput"><span class="keyword">function</span> Bat2MatGUI
<span class="comment">% function Bat2MatGUI</span>
<span class="comment">%</span>
<span class="comment">% An interface for graphing Batlab produced data</span>
<span class="comment">%</span>
<span class="comment">% make sure your javaclasspath is set for this to run</span>

close <span class="string">all</span>
clear <span class="string">variables</span>

import <span class="string">java.awt.event.ActionEvent</span>;
<span class="comment">%import javax.swing.*;</span>
import <span class="string">filetree.*</span>;
import <span class="string">javax.swing.JMenuItem</span>;
import <span class="string">javax.swing.JPopupMenu</span>;

<span class="comment">%this is the matlab portion of the figure, the java generated portion sits</span>
<span class="comment">%on top of this. the width of the javapanel will match the width of the</span>
<span class="comment">%matlab figure</span>
fh = figure;
set(fh, <span class="string">'units'</span>, <span class="string">'normalized'</span>,<span class="string">'position'</span>, [0.1 0.15 0.8 0.1], <span class="string">'menubar'</span>, <span class="string">'none'</span>)
<span class="comment">%set(fh, 'position', [150 150 900 100]);</span>

SetMenuBar(fh);

<span class="comment">%os compatability</span>
<span class="keyword">if</span> isunix || ismac
    rootPath = getenv(<span class="string">'HOME'</span>);
<span class="keyword">elseif</span> ispc
    rootPath = getenv(<span class="string">'USERPROFILE'</span>);
<span class="keyword">else</span>
    warning(<span class="string">'unrecognised/unsupported operating system'</span>);
    rootPath = pwd;
<span class="keyword">end</span>
<span class="keyword">if</span> isempty(rootPath)
    warning(<span class="string">'home folder not found, using current directory for search path'</span>);
    rootPath = pwd;
<span class="keyword">end</span>
slash = GetSlash;

<span class="comment">%rootPath = [pwd slash];</span>
<span class="comment">%make sure the path ends with a slash</span>
<span class="keyword">if</span> ~isequal(rootPath(end), slash)
   rootPath = [rootPath slash];
<span class="keyword">end</span>

<span class="comment">%main interface panel written in java</span>
javaPanel = DataSelectionPanel(rootPath);
[jObj container] = javacomponent(javaPanel, <span class="string">'North'</span>, fh);
set(container, <span class="string">'units'</span>, <span class="string">'normalized'</span>, <span class="string">'position'</span>, [0 0.1 1 0.8]);
<span class="comment">%set(container, 'position', [0 100 900 300]);</span>

<span class="comment">%popup menu for investigating what is in files before running graphs, it is</span>
<span class="comment">%necessary to do this in java as well, uicontextmenu does not work</span>
menuItem = JMenuItem(<span class="string">'File Contents...'</span>);
menuItem2 = JMenuItem(<span class="string">'Preview spikes...'</span>);
set(menuItem, <span class="string">'ActionPerformedCallback'</span>, @exploreFun);
set(menuItem2, <span class="string">'ActionPerformedCallback'</span>, @previewFun);
jMenu = JPopupMenu;
jMenu.add(menuItem);
jMenu.add(menuItem2);
jTree = javaPanel.getTree();
set(jTree, <span class="string">'MousePressedCallback'</span>, {@mousePressedCallback,jMenu});

<span class="comment">%default parameter values</span>
savePath = [pwd slash];
format = <span class="string">'tiff'</span>;
resolutionStr = <span class="string">'normal'</span>;

stimPath = [pwd slash];
colormap = <span class="string">'jet'</span>;
colorRange = [];
txtPath = [];

loadButton = uicontrol(fh, <span class="string">'style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'position'</span>, [15 30 150 50], <span class="string">'string'</span>, <span class="string">'Visualize Data'</span>, <span class="string">'callback'</span>, @loadFun);

panel = uipanel(<span class="string">'parent'</span>, fh, <span class="string">'units'</span>, <span class="string">'pixels'</span>, <span class="string">'position'</span>, [200 15 375 100], <span class="string">'backgroundcolor'</span>, [0.8 0.8 0.8]);
uicontrol(panel, <span class="string">'style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'position'</span>, [10 15 140 25], <span class="string">'string'</span>, <span class="string">'Save Options...'</span>, <span class="string">'callback'</span>, @saveOptions);
saveOption = uicontrol(panel, <span class="string">'style'</span>, <span class="string">'checkbox'</span>, <span class="string">'position'</span>, [10 45 100 30], <span class="string">'string'</span>, <span class="string">'save figures'</span>, <span class="string">'backgroundcolor'</span>, [0.8 0.8 0.8]);
uicontrol(panel, <span class="string">'style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'position'</span>, [200 15 140 25], <span class="string">'string'</span>, <span class="string">'Advanced Options...'</span>, <span class="string">'callback'</span>, @advOptFun);

    <span class="keyword">function</span> saveOptions(hobject, eventdata)
        <span class="comment">%allows user to select save parameters</span>
        [savePath format resolutionStr] = SaveDialog(savePath, format, resolutionStr);
    <span class="keyword">end</span>

    <span class="keyword">function</span> advOptFun(hobject, eventdata)
        <span class="comment">%allows user to select other parameters</span>
        [stimPath colormap colorRange txtPath] = OptionDialog(stimPath, colormap, colorRange, txtPath);
    <span class="keyword">end</span>

    <span class="keyword">function</span> loadFun(hobject, eventdata)
        <span class="comment">%where the magic happens</span>

        disp(<span class="string">'-----------------------------------------------------------'</span>);
        disp(<span class="string">'Loading...'</span>);
        disp(<span class="string">'-----------------------------------------------------------'</span>);
        paths = cellstr(char(javaPanel.getCheckedPaths()));

        <span class="comment">%get what plots to make</span>
        testChoices = javaPanel.getTestChoices();
        traceFlags = javaPanel.getTraceChoices();
        <span class="keyword">if</span> ~any([testChoices; traceFlags])
            disp(<span class="string">'Silly Fool, make some plot choices!'</span>)
            <span class="keyword">return</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> testChoices(1) || testChoices (2)
            imFlags = [testChoices(1) testChoices(2) 0 0 1];
        <span class="keyword">else</span>
            imFlags = 0;
        <span class="keyword">end</span>
        <span class="keyword">if</span> testChoices(3) || testChoices(4)
            conFlags = [testChoices(3) testChoices(4) 0 1 0];
        <span class="keyword">else</span>
            conFlags = 0;
        <span class="keyword">end</span>
        <span class="keyword">if</span> testChoices(5) || testChoices(6)
            surfFlags = [testChoices(5) testChoices(6) 1 0 0];
        <span class="keyword">else</span>
            surfFlags = 0;
        <span class="keyword">end</span>

        saveOn = get(saveOption, <span class="string">'value'</span>);
        <span class="keyword">if</span>(saveOn)
            <span class="keyword">switch</span>(resolutionStr)
                <span class="keyword">case</span> <span class="string">'normal'</span>
                    resolution = 150;
                <span class="keyword">case</span> <span class="string">'high'</span>
                    resolution = 300;
                <span class="keyword">case</span> <span class="string">'very high'</span>
                    resolution = 600;
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="keyword">for</span> a = 1:length(paths)

            <span class="comment">%--------------------------------------------------------------</span>
            <span class="comment">% Get data for Experiment run</span>
            <span class="comment">%--------------------------------------------------------------</span>

            path = [rootPath paths{a}];
            <span class="comment">%Create a preferences structure for the desired experimental data</span>
            prefs = GeneratePreferencesNew(path);
            <span class="keyword">if</span> ~exist(prefs.extracted_data_folder, <span class="string">'file'</span>)
                mkdir(prefs.extracted_data_folder);
            <span class="keyword">end</span>
            name = prefs.cell_id(1:end-1);
            disp([<span class="string">'processing '</span> name]);

            <span class="comment">%user defined preferences</span>
            threshold = str2double(javaPanel.getThreshold(name));
            <span class="keyword">if</span> isnan(threshold)
               disp([<span class="string">'!'</span> name <span class="string">': invalid theshold value, skipping experiment'</span>]);
               <span class="keyword">continue</span>
            <span class="keyword">end</span>
            prefs.spike_time_peak_threshold = threshold;
            prefs.audio_directory = stimPath;
            prefs.colormap = eval(colormap);
            prefs.colormap_name = colormap;

            <span class="comment">%Extract XML metadata and convert to to Matlab structure</span>
            experiment_data = LoadExperimentData(prefs);

            <span class="comment">%==============================================================</span>
            <span class="comment">%Test Visualizsation</span>
            <span class="comment">%--------------------------------------------------------------</span>
            <span class="comment">%get the test numbers to do whole test analysis on</span>
            testNumString = char(javaPanel.getTests1(name));
            <span class="keyword">if</span> ~isempty(testNumString)
                <span class="comment">%get the test numbers and check input for errors</span>
<span class="comment">%                 testNumList = textscan(testNumString, '%s');</span>
<span class="comment">%                 testNumList = testNumList{1}.';</span>
<span class="comment">%                 temp = [];</span>
<span class="comment">%                 for t = testNumList</span>
<span class="comment">%                     testNum = str2double(t{1});</span>
<span class="comment">%                     if isnan(testNum)</span>
<span class="comment">%                         disp(['!Test ' t{1} ' : invalid test number']);</span>
<span class="comment">%                     else</span>
<span class="comment">%                         temp = [temp testNum];</span>
<span class="comment">%                     end</span>
<span class="comment">%                 end</span>
<span class="comment">%                 testNumList = temp;</span>
                testNumList = string2numbers(testNumString);
                <span class="comment">%produce desired plots for each test</span>
                <span class="keyword">for</span> testNum = testNumList
                    <span class="keyword">try</span>
                        <span class="keyword">if</span> any(imFlags)
                            <span class="keyword">if</span>(saveOn)
                                VisualizeTestData(experiment_data,prefs,testNum,imFlags, savePath, format, resolution, colorRange);
                            <span class="keyword">else</span>
                                VisualizeTestData(experiment_data,prefs,testNum,imFlags, [], [], [], colorRange);
                            <span class="keyword">end</span>
                        <span class="keyword">end</span>

                        <span class="keyword">if</span> any(conFlags)
                           <span class="keyword">if</span>(saveOn)
                              VisualizeTestData(experiment_data,prefs,testNum,conFlags, savePath, format, resolution, colorRange);
                           <span class="keyword">else</span>
                              VisualizeTestData(experiment_data,prefs,testNum,conFlags, [], [], [], colorRange);
                           <span class="keyword">end</span>
                        <span class="keyword">end</span>

                        <span class="keyword">if</span> any(surfFlags)
                            <span class="keyword">if</span>(saveOn)
                                VisualizeTestData(experiment_data,prefs,testNum,surfFlags, savePath, format, resolution, colorRange);
                            <span class="keyword">else</span>
                                VisualizeTestData(experiment_data,prefs,testNum,surfFlags, [], [], [], colorRange);
                            <span class="keyword">end</span>
                        <span class="keyword">end</span>
                    <span class="keyword">catch</span> e
                        disp([<span class="string">'!Test '</span> num2str(testNum) <span class="string">': '</span> e.message ]);
                        <span class="comment">%rethrow(e)</span>
                        <span class="keyword">continue</span>
                    <span class="keyword">end</span>

                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">%==============================================================</span>
            <span class="comment">%Trace Visualization</span>
            <span class="comment">%--------------------------------------------------------------</span>
            <span class="comment">%Do trace analysis</span>
            clear <span class="string">testNumString</span>;
            clear <span class="string">traceNumString</span>;

            <span class="comment">%get test numbers for analysis, do nothing if empty</span>
            testNumString = char(javaPanel.getTests2(name));
            <span class="keyword">if</span> ~isempty(testNumString)
<span class="comment">%                 testNumList = textscan(testNumString, '%s');</span>
<span class="comment">%                 testNumList = testNumList{1}.'; %turn into row vector</span>
<span class="comment">%                 temp = [];</span>
<span class="comment">%                 for t = testNumList</span>
<span class="comment">%                     testNum = str2double(t{1});</span>
<span class="comment">%                     if isnan(testNum)</span>
<span class="comment">%                         disp(['!Test ' t{1} ' : invalid test number']);</span>
<span class="comment">%                     else</span>
<span class="comment">%                         temp = [temp testNum];</span>
<span class="comment">%                     end</span>
<span class="comment">%                 end</span>
<span class="comment">%                 testNumList = temp;</span>
                testNumList = string2numbers(testNumString);

                traceNumString = char(javaPanel.getTraces(name));

                <span class="keyword">if</span> isempty(traceNumString)
                    disp([<span class="string">'!'</span> prefs.cell_id(1:end-1) <span class="string">' : you must select a choice for traces'</span>]);
                <span class="comment">%all radio button selected</span>
                <span class="keyword">elseif</span> strcmp(traceNumString, <span class="string">'all'</span>)
                    <span class="keyword">if</span> ~isempty(txtPath)
                        textFileOutput(experiment_data, prefs, testNumList, [], traceFlags, txtPath);
                        <span class="keyword">continue</span>
                    <span class="keyword">end</span>
                    <span class="keyword">for</span> testNum = testNumList
                        <span class="keyword">try</span>
                        <span class="comment">%get all the traces for each test</span>
                            traceNums = 1:length(experiment_data.test(testNum).trace);
                            <span class="keyword">for</span> traceNum = traceNums
                                <span class="keyword">if</span> saveOn
                                    VisualizeTraceData(experiment_data,prefs,testNum,traceNum,traceFlags, savePath, format, resolution);
                                <span class="keyword">else</span>
                                    VisualizeTraceData(experiment_data,prefs,testNum,traceNum,traceFlags);
                                <span class="keyword">end</span>
                            <span class="keyword">end</span>
                        <span class="keyword">catch</span> e
                            disp([<span class="string">'!Test '</span> num2str(testNum) <span class="string">': '</span> e.message ]);
                            <span class="keyword">continue</span>
                            <span class="comment">%rethrow(e)</span>
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                <span class="comment">%select traces radio selected</span>
                <span class="keyword">else</span>
                    <span class="keyword">for</span> testNum = testNumList
                        <span class="keyword">try</span>
                            <span class="comment">%matches each test num to its trace num(s) in the</span>
                            <span class="comment">%trace num field</span>
                            <span class="keyword">try</span>
                                [traceNum traceNumString] = strtok(traceNumString);
                                traceNum = eval(traceNum);
                            <span class="keyword">catch</span> e
                                disp([<span class="string">'!Test '</span> num2str(testNum) <span class="string">': invalid trace number input, '</span> traceNum]) <span class="comment">%--version 10</span>
                                <span class="comment">% errordlg('Invalid Input, use numbers or valid mathmatical expressions only') %--version 7</span>
                                <span class="comment">%rethrow(e)</span>
                                <span class="comment">%lasterr %--version 7</span>
                                <span class="keyword">continue</span>
                            <span class="keyword">end</span>
<span class="comment">%                             if length(traceNum) &gt;1</span>
                                <span class="keyword">for</span> thisTrace = traceNum

                                    <span class="keyword">if</span> saveOn
                                        VisualizeTraceData(experiment_data, prefs, testNum, thisTrace,traceFlags,savePath, format,resolution);
                                    <span class="keyword">else</span>
                                        VisualizeTraceData(experiment_data, prefs, testNum, thisTrace,traceFlags);
                                    <span class="keyword">end</span>
                                <span class="keyword">end</span>
<span class="comment">%                             else</span>
<span class="comment">%                                 if saveOn</span>
<span class="comment">%                                    VisualizeTraceData(experiment_data, prefs, testNum,traceNum, traceFlags, savePath, format, resolution);</span>
<span class="comment">%                                 else</span>
<span class="comment">%                                    VisualizeTraceData(experiment_data, prefs, testNum,traceNum, traceFlags);</span>
<span class="comment">%                                 end</span>
<span class="comment">%                             end</span>
                        <span class="keyword">catch</span> e
                            disp([<span class="string">'!Test '</span> num2str(testNum) <span class="string">': '</span> e.message ]);
                            <span class="comment">% errordlg('Invalid Input, use numbers or valid mathmatical expressions only') %--version 7</span>
                            <span class="comment">%rethrow(e)</span>
                            <span class="comment">%lasterr %--version 7</span>
                            <span class="keyword">continue</span>
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">%==============================================================</span>

        <span class="keyword">end</span>
        disp(<span class="string">'-----------------------------------------------------------'</span>);
        disp(<span class="string">'Complete'</span>);
        disp(<span class="string">'-----------------------------------------------------------'</span>);
    <span class="keyword">end</span>

    <span class="keyword">function</span> mousePressedCallback(htree, eventData, jmenu)
        <span class="keyword">if</span> eventData.isMetaDown
            x = eventData.getX;
            y = eventData.getY;
            jMenu.show(jTree, x, y);
            jMenu.repaint;
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">function</span> exploreFun(hObj, eventData)
        path = char(javaPanel.getCurrentSelection());
        path = [rootPath path];
        prefs = GeneratePreferencesNew(path);
        experimentData = LoadExperimentData(prefs);
        ExploreTestData(experimentData);
    <span class="keyword">end</span>

    <span class="keyword">function</span> previewFun(jObj, eventData)
        path = char(javaPanel.getCurrentSelection());
        path = [rootPath path];
        prefs = GeneratePreferencesNew(path);
        experimentData = LoadExperimentData(prefs);
        traceChooser(prefs, experimentData);
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><pre class="codeoutput">Undefined function or method 'DataSelectionPanel' for input arguments of type 'char'.

Error in ==&gt; Bat2MatGUI at 48
javaPanel = DataSelectionPanel(rootPath);
</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.10<br></p></div><!--
##### SOURCE BEGIN #####
function Bat2MatGUI
% function Bat2MatGUI
%
% An interface for graphing Batlab produced data
%
% make sure your javaclasspath is set for this to run

close all
clear variables

import java.awt.event.ActionEvent;
%import javax.swing.*;
import filetree.*;
import javax.swing.JMenuItem;
import javax.swing.JPopupMenu;

%this is the matlab portion of the figure, the java generated portion sits
%on top of this. the width of the javapanel will match the width of the
%matlab figure
fh = figure;
set(fh, 'units', 'normalized','position', [0.1 0.15 0.8 0.1], 'menubar', 'none')
%set(fh, 'position', [150 150 900 100]);

SetMenuBar(fh);

%os compatability
if isunix || ismac
    rootPath = getenv('HOME');
elseif ispc
    rootPath = getenv('USERPROFILE');
else 
    warning('unrecognised/unsupported operating system');
    rootPath = pwd;
end
if isempty(rootPath)
    warning('home folder not found, using current directory for search path');
    rootPath = pwd;
end
slash = GetSlash;

%rootPath = [pwd slash];
%make sure the path ends with a slash
if ~isequal(rootPath(end), slash)
   rootPath = [rootPath slash];
end

%main interface panel written in java
javaPanel = DataSelectionPanel(rootPath);
[jObj container] = javacomponent(javaPanel, 'North', fh);
set(container, 'units', 'normalized', 'position', [0 0.1 1 0.8]);
%set(container, 'position', [0 100 900 300]);

%popup menu for investigating what is in files before running graphs, it is
%necessary to do this in java as well, uicontextmenu does not work
menuItem = JMenuItem('File Contents...');
menuItem2 = JMenuItem('Preview spikes...');
set(menuItem, 'ActionPerformedCallback', @exploreFun);
set(menuItem2, 'ActionPerformedCallback', @previewFun);
jMenu = JPopupMenu;
jMenu.add(menuItem);
jMenu.add(menuItem2);
jTree = javaPanel.getTree();
set(jTree, 'MousePressedCallback', {@mousePressedCallback,jMenu});

%default parameter values
savePath = [pwd slash];
format = 'tiff';
resolutionStr = 'normal';

stimPath = [pwd slash];
colormap = 'jet';
colorRange = [];
txtPath = [];
 
loadButton = uicontrol(fh, 'style', 'pushbutton', 'position', [15 30 150 50], 'string', 'Visualize Data', 'callback', @loadFun);

panel = uipanel('parent', fh, 'units', 'pixels', 'position', [200 15 375 100], 'backgroundcolor', [0.8 0.8 0.8]);
uicontrol(panel, 'style', 'pushbutton', 'position', [10 15 140 25], 'string', 'Save Options...', 'callback', @saveOptions);
saveOption = uicontrol(panel, 'style', 'checkbox', 'position', [10 45 100 30], 'string', 'save figures', 'backgroundcolor', [0.8 0.8 0.8]);
uicontrol(panel, 'style', 'pushbutton', 'position', [200 15 140 25], 'string', 'Advanced Options...', 'callback', @advOptFun);

    function saveOptions(hobject, eventdata)
        %allows user to select save parameters
        [savePath format resolutionStr] = SaveDialog(savePath, format, resolutionStr);
    end

    function advOptFun(hobject, eventdata)
        %allows user to select other parameters
        [stimPath colormap colorRange txtPath] = OptionDialog(stimPath, colormap, colorRange, txtPath);
    end

    function loadFun(hobject, eventdata)
        %where the magic happens
        
        disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
        disp('Loading...');
        disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
        paths = cellstr(char(javaPanel.getCheckedPaths()));

        %get what plots to make
        testChoices = javaPanel.getTestChoices();
        traceFlags = javaPanel.getTraceChoices();
        if ~any([testChoices; traceFlags])
            disp('Silly Fool, make some plot choices!')
            return
        end
        if testChoices(1) || testChoices (2)
            imFlags = [testChoices(1) testChoices(2) 0 0 1];
        else
            imFlags = 0;
        end
        if testChoices(3) || testChoices(4)
            conFlags = [testChoices(3) testChoices(4) 0 1 0];
        else 
            conFlags = 0;
        end
        if testChoices(5) || testChoices(6)
            surfFlags = [testChoices(5) testChoices(6) 1 0 0];
        else 
            surfFlags = 0;
        end  
        
        saveOn = get(saveOption, 'value');
        if(saveOn)
            switch(resolutionStr)
                case 'normal'
                    resolution = 150;
                case 'high'
                    resolution = 300;
                case 'very high'
                    resolution = 600;
            end     
        end
        
        for a = 1:length(paths)
            
            %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
            % Get data for Experiment run
            %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
            
            path = [rootPath paths{a}];
            %Create a preferences structure for the desired experimental data
            prefs = GeneratePreferencesNew(path);
            if ~exist(prefs.extracted_data_folder, 'file')
                mkdir(prefs.extracted_data_folder);
            end
            name = prefs.cell_id(1:end-1);
            disp(['processing ' name]);
            
            %user defined preferences
            threshold = str2double(javaPanel.getThreshold(name));
            if isnan(threshold)
               disp(['!' name ': invalid theshold value, skipping experiment']);
               continue
            end
            prefs.spike_time_peak_threshold = threshold;            
            prefs.audio_directory = stimPath;
            prefs.colormap = eval(colormap);
            prefs.colormap_name = colormap;
            
            %Extract XML metadata and convert to to Matlab structure           
            experiment_data = LoadExperimentData(prefs);
                        
            %==============================================================
            %Test Visualizsation
            %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
            %get the test numbers to do whole test analysis on
            testNumString = char(javaPanel.getTests1(name));
            if ~isempty(testNumString)
                %get the test numbers and check input for errors
%                 testNumList = textscan(testNumString, '%s');                
%                 testNumList = testNumList{1}.';
%                 temp = [];
%                 for t = testNumList
%                     testNum = str2double(t{1});
%                     if isnan(testNum)
%                         disp(['!Test ' t{1} ' : invalid test number']);
%                     else
%                         temp = [temp testNum];
%                     end
%                 end
%                 testNumList = temp;
                testNumList = string2numbers(testNumString);
                %produce desired plots for each test
                for testNum = testNumList        
                    try
                        if any(imFlags)
                            if(saveOn)
                                VisualizeTestData(experiment_data,prefs,testNum,imFlags, savePath, format, resolution, colorRange);
                            else
                                VisualizeTestData(experiment_data,prefs,testNum,imFlags, [], [], [], colorRange);
                            end                            
                        end
                        
                        if any(conFlags)
                           if(saveOn)
                              VisualizeTestData(experiment_data,prefs,testNum,conFlags, savePath, format, resolution, colorRange);
                           else
                              VisualizeTestData(experiment_data,prefs,testNum,conFlags, [], [], [], colorRange);    
                           end
                        end
                        
                        if any(surfFlags)
                            if(saveOn)
                                VisualizeTestData(experiment_data,prefs,testNum,surfFlags, savePath, format, resolution, colorRange);
                            else
                                VisualizeTestData(experiment_data,prefs,testNum,surfFlags, [], [], [], colorRange);   
                            end
                        end                        
                    catch e
                        disp(['!Test ' num2str(testNum) ': ' e.message ]);
                        %rethrow(e)
                        continue
                    end
                    
                end
            end
            %==============================================================
            %Trace Visualization
            %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
            %Do trace analysis
            clear testNumString;
            clear traceNumString;
            
            %get test numbers for analysis, do nothing if empty
            testNumString = char(javaPanel.getTests2(name));
            if ~isempty(testNumString)
%                 testNumList = textscan(testNumString, '%s');
%                 testNumList = testNumList{1}.'; %turn into row vector
%                 temp = [];
%                 for t = testNumList
%                     testNum = str2double(t{1});
%                     if isnan(testNum)
%                         disp(['!Test ' t{1} ' : invalid test number']);
%                     else
%                         temp = [temp testNum];
%                     end
%                 end
%                 testNumList = temp;
                testNumList = string2numbers(testNumString);
                
                traceNumString = char(javaPanel.getTraces(name));
                                
                if isempty(traceNumString)
                    disp(['!' prefs.cell_id(1:end-1) ' : you must select a choice for traces']);
                %all radio button selected 
                elseif strcmp(traceNumString, 'all')
                    if ~isempty(txtPath)
                        textFileOutput(experiment_data, prefs, testNumList, [], traceFlags, txtPath);
                        continue
                    end
                    for testNum = testNumList
                        try
                        %get all the traces for each test
                            traceNums = 1:length(experiment_data.test(testNum).trace);
                            for traceNum = traceNums                               
                                if saveOn
                                    VisualizeTraceData(experiment_data,prefs,testNum,traceNum,traceFlags, savePath, format, resolution);
                                else
                                    VisualizeTraceData(experiment_data,prefs,testNum,traceNum,traceFlags);   
                                end
                            end
                        catch e
                            disp(['!Test ' num2str(testNum) ': ' e.message ]);
                            continue
                            %rethrow(e)
                        end
                    end                    
                %select traces radio selected
                else
                    for testNum = testNumList
                        try
                            %matches each test num to its trace num(s) in the
                            %trace num field
                            try
                                [traceNum traceNumString] = strtok(traceNumString);
                                traceNum = eval(traceNum);
                            catch e
                                disp(['!Test ' num2str(testNum) ': invalid trace number input, ' traceNum]) %REPLACE_WITH_DASH_DASHversion 10
                                % errordlg('Invalid Input, use numbers or valid mathmatical expressions only') %REPLACE_WITH_DASH_DASHversion 7
                                %rethrow(e)
                                %lasterr %REPLACE_WITH_DASH_DASHversion 7
                                continue
                            end
%                             if length(traceNum) >1
                                for thisTrace = traceNum                                        

                                    if saveOn
                                        VisualizeTraceData(experiment_data, prefs, testNum, thisTrace,traceFlags,savePath, format,resolution);
                                    else
                                        VisualizeTraceData(experiment_data, prefs, testNum, thisTrace,traceFlags);  
                                    end
                                end
%                             else
%                                 if saveOn
%                                    VisualizeTraceData(experiment_data, prefs, testNum,traceNum, traceFlags, savePath, format, resolution); 
%                                 else
%                                    VisualizeTraceData(experiment_data, prefs, testNum,traceNum, traceFlags); 
%                                 end
%                             end                    
                        catch e
                            disp(['!Test ' num2str(testNum) ': ' e.message ]); 
                            % errordlg('Invalid Input, use numbers or valid mathmatical expressions only') %REPLACE_WITH_DASH_DASHversion 7
                            %rethrow(e)
                            %lasterr %REPLACE_WITH_DASH_DASHversion 7
                            continue
                        end
                    end
                end
            end
            %==============================================================
            
        end
        disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
        disp('Complete');
        disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
    end

    function mousePressedCallback(htree, eventData, jmenu)
        if eventData.isMetaDown
            x = eventData.getX;
            y = eventData.getY;
            jMenu.show(jTree, x, y);
            jMenu.repaint;
        end
    end

    function exploreFun(hObj, eventData)
        path = char(javaPanel.getCurrentSelection());
        path = [rootPath path];
        prefs = GeneratePreferencesNew(path);
        experimentData = LoadExperimentData(prefs);
        ExploreTestData(experimentData);
    end

    function previewFun(jObj, eventData)
        path = char(javaPanel.getCurrentSelection());
        path = [rootPath path];
        prefs = GeneratePreferencesNew(path);
        experimentData = LoadExperimentData(prefs);
        traceChooser(prefs, experimentData);
    end
end
##### SOURCE END #####
--></body></html>